<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2026-02-20 Fri 21:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ob-prompt.el — Org Babel for LLM Prompts</title>
<meta name="author" content="@@html:&lt;a href=&quot;https://slashpablo.com&quot;&gt;&lt;span class=&quot;slash&quot;&gt;&lt;/span&gt;pablo&lt;/a&gt;@@" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/code-copy.css"/>
<link rel="stylesheet" type="text/css" href="src/readtheorg_theme/css/search.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/search.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/code-copy.js"></script>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/search.css"/>
<link rel="stylesheet" type="text/css" href="ob-prompt.css"/>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<a href="https://github.com/slashpablo/ob-prompt" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: fixed; top: 0; border: 0; right: 0; z-index: 1000;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.support-fab,.support-fab:visited,.support-fab:link{position:fixed;bottom:28px;right:28px;z-index:1000;background:rgba(0,0,0,.45);color:#fff;text-decoration:none;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:13px;font-weight:500;padding:8px 14px;border-radius:50px;box-shadow:0 1px 4px rgba(0,0,0,.15);opacity:.6;transition:opacity .2s,box-shadow .2s}.support-fab:hover{opacity:1;box-shadow:0 2px 8px rgba(0,0,0,.25);color:#fff}@media(max-width:500px){.support-fab,.support-fab:visited,.support-fab:link{bottom:16px;right:16px;padding:6px 12px;font-size:12px}}</style>
<a href="https://www.patreon.com/c/slashpablo" class="support-fab" aria-label="Support this project">&#9829; Support</a>
</head>
<body>
<div id="content" class="content">
<h1 class="title">ob-prompt.el — Org Babel for LLM Prompts</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgdae59a8">1. Prerequisites</a></li>
<li><a href="#org87dbcda">2. Introduction</a></li>
<li><a href="#org4c34ea4">3. Quick Start</a></li>
<li><a href="#orgd8ac596">4. Header Arguments</a>
<ul>
<li><a href="#org295dd9a">4.1. Custom Header Arguments</a></li>
<li><a href="#org8ca02b3">4.2. Default Header Arguments</a></li>
</ul>
</li>
<li><a href="#org14ffe74">5. Variable Expansion</a></li>
<li><a href="#orgcbfabf0">6. Message Assembly</a>
<ul>
<li><a href="#org322dbca">6.1. Example</a></li>
</ul>
</li>
<li><a href="#orgd26f682">7. HTTP backend</a>
<ul>
<li><a href="#org1847d7e">7.1. Building the Request Payload</a>
<ul>
<li><a href="#org7929682">7.1.1. Example</a></li>
</ul>
</li>
<li><a href="#org27f96da">7.2. Parsing the Response</a>
<ul>
<li><a href="#orgbb29c94">7.2.1. Example</a></li>
</ul>
</li>
<li><a href="#orgffb8d9d">7.3. ASCII-safe JSON Encoding</a></li>
<li><a href="#org7925bb9">7.4. HTTP Transport</a></li>
</ul>
</li>
<li><a href="#org054fe71">8. CLI Backend</a>
<ul>
<li><a href="#orgcc93e6a">8.1. Building CLI Input</a></li>
<li><a href="#org4d75a31">8.2. Shell Transport</a></li>
</ul>
</li>
<li><a href="#org2089a9f">9. The Core Execution Function</a></li>
<li><a href="#org5681d58">10. Debug Mode</a></li>
<li><a href="#orgc230d27">11. Session Support (stub)</a></li>
<li><a href="#org99c8ade">12. Running Tests</a></li>
<li><a href="#orgdb667da">13. Example Usage</a>
<ul>
<li><a href="#orgdff7531">13.1. Basic prompt</a></li>
<li><a href="#orgd1d4e2b">13.2. With a system prompt</a></li>
<li><a href="#orgc628981">13.3. With variables from other blocks</a></li>
<li><a href="#orgd22ad27">13.4. Using :preamble for document context</a></li>
<li><a href="#org742aa22">13.5. Using :command for CLI tools</a></li>
</ul>
</li>
<li><a href="#org1827a6b">14. File Assembly</a>
<ul>
<li><a href="#orgad17b79">14.1. File header</a></li>
<li><a href="#orgc927e9b">14.2. Provide</a></li>
<li><a href="#orgfe54d00">14.3. Tangled output</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgdae59a8" class="outline-2">
<h2 id="orgdae59a8"><span class="section-number-2">1.</span> Prerequisites</h2>
<div class="outline-text-2" id="text-1">
<p>
This document assumes basic familiarity with:
</p>

<ul class="org-ul">
<li>Emacs (editing files, evaluating code)</li>
<li>Org mode (headings, src blocks, <code>C-c C-c</code> execution)</li>
</ul>

<p>
You do <b>not</b> need to be an Org or Babel expert to use <code>ob-prompt</code>, but
if this is your first exposure to Emacs or Org mode, the raw source of
this file may feel dense.
</p>

<p>
If you’re new, start here:
</p>

<ul class="org-ul">
<li>Emacs: <a href="https://www.gnu.org/software/emacs/">https://www.gnu.org/software/emacs/</a></li>
<li>Org mode manual: <a href="https://orgmode.org/manual/">https://orgmode.org/manual/</a></li>
<li>Org Babel overview: <a href="https://orgmode.org/manual/Working-with-Source-Code.html">https://orgmode.org/manual/Working-with-Source-Code.html</a></li>
</ul>

<p>
Once you understand what an Org src block is and how <code>C-c C-c</code> works,
everything in this document should read naturally.
</p>
</div>
</div>
<div id="outline-container-org87dbcda" class="outline-2">
<h2 id="org87dbcda"><span class="section-number-2">2.</span> Introduction</h2>
<div class="outline-text-2" id="text-2">
<p>
<code>ob-prompt</code> turns Org Babel into a lightweight, reproducible interface
for large language models.  A prompt is just a src block:
</p>

<pre class="example" id="org7534b61">
#+begin_src prompt :model claude-sonnet-4-6
Explain how LLMs aid in creating literate programs.
#+end_src
</pre>

<p>
Press <code>C-c C-c</code> and the response appears as a <code>#+RESULTS:</code> block.
Variables, system prompts, and the <code>:preamble</code> mechanism (which feeds
the buffer content above the block as context) all compose naturally
with the rest of Org.
</p>

<p>
Two execution backends are supported:
</p>

<ul class="org-ul">
<li><b>HTTP</b>: Sends prompts to any OpenAI-compatible API endpoint.</li>
<li><b>CLI</b>: Pipes prompts through a shell command (<code>:command</code>), so any
CLI tool that reads stdin and writes stdout becomes an LLM backend,
e.g. <code>claude code</code>.</li>
</ul>

<p>
This documentation actually contains the prompt blocks that were used
to write it, along with the LLM responses they produced at the time.
In other words, the text you are reading is itself the result of
executing those prompts.
</p>

<p>
The document therefore doubles as both:
</p>

<ul class="org-ul">
<li>A manual for <code>ob-prompt</code></li>
<li>A worked, reproducible example of using Org Babel to collaborate with
an LLM while writing documentation</li>
</ul>

<p>
The following is how you will encounter my prompts and their respones:
</p>

<div class="org-src-container">
<pre class="src src-prompt">Hey LLM, cast a spell on the reader to give them good luck and have their code never throw!
</pre>
</div>

<div class="assistant" id="org21782b6">
<p>
By the parentheses of Lisp and the quiet power of plain text,
I bestow upon you this small but sincere enchantment.
</p>

<p>
May your buffers stay uncorrupted,
your diffs be minimal and intentional,
and your abstractions reveal themselves at just the right moment.
</p>

<p>
May warnings speak early, errors arrive rarely,
and when a bug appears, may it confess immediately
under a single well-placed <code>M-x eval-buffer</code>.
</p>

<p>
Go forth with steady hands and reproducible builds.
Your code shall not throw — and if it ever does,
it will do so kindly, with a clear stack trace.
</p>

<p>
So it is written.
</p>

</div>
</div>
</div>
<div id="outline-container-org4c34ea4" class="outline-2">
<h2 id="org4c34ea4"><span class="section-number-2">3.</span> Quick Start</h2>
<div class="outline-text-2" id="text-3">
<p>
Get the code from <a href="https://github.com/slashpablo/ob-prompt">GitHub</a> and add the following to your Emacs
configuration:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(add-to-list 'load-path <span class="org-string">"/path/to/ob-prompt"</span>)

(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (prompt . t)))
</pre>
</div>

<p>
Then write a prompt block and press <code>C-c C-c</code>:
</p>

<pre class="example" id="orge392ce4">
#+begin_src prompt :model claude-sonnet-4-6
Explain monads in simple terms.
#+end_src
</pre>

<p>
The implementation is split into small helpers.  Each section
introduces a concept, shows the code, then demonstrates it with a
live example you can <code>C-c C-c</code> to see the actual output.  The full
automated test suite lives separately in <code>ob-prompt-test.el</code>.
</p>
</div>
</div>
<div id="outline-container-orgd8ac596" class="outline-2">
<h2 id="orgd8ac596"><span class="section-number-2">4.</span> Header Arguments</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org295dd9a" class="outline-3">
<h3 id="org295dd9a"><span class="section-number-3">4.1.</span> Custom Header Arguments</h3>
<div class="outline-text-3" id="text-4-1">
<p>
These are the prompt-specific header arguments.  Babel merges them
with the standard set (<code>:results</code>, <code>:exports</code>, <code>:var</code>, <code>:session</code>,
etc.).  Declaring them here enables completion in the block header.
</p>

<p>
Any <code>:keyword value</code> pair flows through to <code>params</code> regardless of
whether it is declared - but listing them explicitly is good hygiene.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org6ffcbb1">(<span class="org-keyword">defconst</span> <span class="org-variable-name">org-babel-header-args:prompt</span>
  '((model    . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">LLM model identifier
</span>    (system   . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">system prompt string
</span>    (endpoint . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">API endpoint URL
</span>    (api-key  . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">API key (string or evaluated form)
</span>    (preamble . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">include buffer content above block as context
</span>    (command  . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">shell command for CLI backend (reads stdin)
</span>    (debug    . <span class="org-builtin">:any</span>))  <span class="org-comment-delimiter">;; </span><span class="org-comment">return raw request/response instead of content
</span>  <span class="org-doc">"Prompt-specific header arguments for ob-prompt."</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org8ca02b3" class="outline-3">
<h3 id="org8ca02b3"><span class="section-number-3">4.2.</span> Default Header Arguments</h3>
<div class="outline-text-3" id="text-4-2">
<p>
When no header arguments are provided, the following defaults
apply. They are chosen to integrate smoothly with an in-document
prompting workflow and minimize boilerplate while remaining explicit
and reproducible.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org6117e86">(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-babel-default-header-args:prompt</span>
  '((<span class="org-builtin">:results</span> . <span class="org-string">"raw"</span>)
    (<span class="org-builtin">:exports</span> . <span class="org-string">"both"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Ensures both prompt and result are exported
</span>    (<span class="org-builtin">:eval</span> . <span class="org-string">"no-export"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Do not re-evaluate prompt blocks on export
</span>    (<span class="org-builtin">:wrap</span> . <span class="org-string">"assistant"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Provide concrete boundries to responses
</span>    (<span class="org-builtin">:noweb</span> . <span class="org-string">"yes"</span>)) <span class="org-comment-delimiter">;; </span><span class="org-comment">Enable &lt;&lt;block-name&gt;&gt; inclusion by default
</span>  <span class="org-doc">"Default header arguments for prompt src blocks."</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org14ffe74" class="outline-2">
<h2 id="org14ffe74"><span class="section-number-2">5.</span> Variable Expansion</h2>
<div class="outline-text-2" id="text-5">
<p>
Babel's default variable expansion prepends <code>name=value</code> lines before
the block body — a convention designed for programming languages where
such assignments are syntactically valid.  In a prose prompt, those
extra lines produce nonsensical output.  Our expand function instead
performs inline <code>$name</code> substitution directly in the body text, so
variables read naturally within the surrounding prose.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orge08cc47">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-expand-body:prompt</span> (body params)
  <span class="org-doc">"Expand BODY for a prompt block by substituting :var references.
Each :var binding replaces $name in BODY with the variable's value."</span>
  (<span class="org-keyword">let</span> ((expanded body))
    (<span class="org-keyword">dolist</span> (pair (org-babel--get-vars params) expanded)
      (<span class="org-keyword">setq</span> expanded
            (replace-regexp-in-string
             (regexp-quote (format <span class="org-string">"$%s"</span> (car pair)))
             (<span class="org-keyword">save-match-data</span> (format <span class="org-string">"%s"</span> (cdr pair)))
             expanded
             t t)))))
</pre>
</div>

<pre class="example" id="orgbb2119c">
#+name:double
#+begin_src python :python3
  def double(x):
      return 3 * x
#+end_src

#+begin_src prompt
What is wrong with my code?

&lt;&lt;double&gt;&gt;
#+end_src

#+RESULTS:
#+begin_assistant
The function’s behavior does not match its name.

=double= implies multiplying by 2, but the implementation multiplies by 3.  
Either rename the function (e.g. =triple=) or change the body to:

return 2 * x

As written, the code is syntactically correct but semantically misleading.
#+end_assistant
</pre>
</div>
</div>
<div id="outline-container-orgcbfabf0" class="outline-2">
<h2 id="orgcbfabf0"><span class="section-number-2">6.</span> Message Assembly</h2>
<div class="outline-text-2" id="text-6">
<p>
The <code>messages</code> array is the core data structure sent to any
OpenAI-compatible API. This helper assembles it from the prompt body
and optional system/preamble context, returning a vector of alists
ready for <code>json-encode</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org67faf7b">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-messages</span> (body <span class="org-type">&amp;optional</span> system preamble-text)
  <span class="org-doc">"Build the messages vector for the API request.
BODY is the user's prompt text.
SYSTEM, when non-nil, becomes a system message.
PREAMBLE-TEXT, when non-nil, is wrapped in &lt;context&gt; tags
and prepended to the user message."</span>
  (<span class="org-keyword">let</span> ((user-content (<span class="org-keyword">if</span> preamble-text
                          (format <span class="org-string">"&lt;context&gt;\n%s\n&lt;/context&gt;\n\n%s"</span>
                                  preamble-text body)
                        body))
        (messages '()))
    (<span class="org-keyword">when</span> system
      (<span class="org-keyword">push</span> `((role . <span class="org-string">"system"</span>) (content . ,system)) messages))
    (<span class="org-keyword">push</span> `((role . <span class="org-string">"user"</span>) (content . ,user-content)) messages)
    (vconcat (nreverse messages))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-prompt">Explain the role of vconcat
</pre>
</div>

<div class="assistant" id="org7d50260">
<p>
<code>vconcat</code> converts a Lisp list into a vector.
</p>

<p>
In this context, the OpenAI-compatible API expects <code>messages</code> to be an
array, not a list.  In Emacs Lisp, JSON arrays are encoded from vectors,
while lists are ambiguous and often encode as objects instead.
</p>

<p>
The function builds <code>messages</code> incrementally as a list (easy to push
onto), then uses <code>vconcat</code> to produce a vector with the same elements,
ensuring <code>json-encode</code> emits a proper JSON array in the request payload.
</p>

</div>
</div>
<div id="outline-container-org322dbca" class="outline-3">
<h3 id="org322dbca"><span class="section-number-3">6.1.</span> Example</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(ob-prompt--build-messages
 <span class="org-string">"What patterns do you see?"</span>
 <span class="org-string">"You are a code reviewer."</span>
 <span class="org-string">"* Header\nSome earlier buffer content..."</span>)
</pre>
</div>

<pre class="example" id="orge6e4956">
[((role . "system") (content . "You are a code reviewer."))
 ((role . "user")
  (content
   . "&lt;context&gt;\n* Header\nSome earlier buffer content...\n&lt;/context&gt;\n\nWhat patterns do you see?"))]
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd26f682" class="outline-2">
<h2 id="orgd26f682"><span class="section-number-2">7.</span> HTTP backend</h2>
<div class="outline-text-2" id="text-7">
<p>
ob-prompt ships with a built-in HTTP backend that speaks the
OpenAI-compatible chat completions protocol.  It is the default
transport — used whenever <code>:command</code> is absent.
</p>
</div>
<div id="outline-container-org1847d7e" class="outline-3">
<h3 id="org1847d7e"><span class="section-number-3">7.1.</span> Building the Request Payload</h3>
<div class="outline-text-3" id="text-7-1">
<p>
The payload is the top-level JSON object sent to the API.  Keeping
this as a separate helper means we can test the exact structure
without touching the network.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org18ebe48">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-payload</span> (model messages)
  <span class="org-doc">"Build the JSON-ready alist for the API request.
MODEL is the model identifier string.
MESSAGES is the vector returned by `</span><span class="org-doc"><span class="org-constant">ob-prompt--build-messages</span></span><span class="org-doc">'."</span>
  `((<span class="org-string">"model"</span> . ,model)
    (<span class="org-string">"max_completion_tokens"</span> . 16384)
    (<span class="org-string">"messages"</span> . ,messages)))
</pre>
</div>
</div>
<div id="outline-container-org7929682" class="outline-4">
<h4 id="org7929682"><span class="section-number-4">7.1.1.</span> Example</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
The full payload, ready to be passed to <code>json-encode</code>:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(ob-prompt--build-payload
 <span class="org-string">"gpt-4"</span>
 (ob-prompt--build-messages <span class="org-string">"Explain monads."</span>))
</pre>
</div>

<pre class="example" id="org751688c">
(("model" . "gpt-4") ("max_completion_tokens" . 16384)
 ("messages" . [((role . "user") (content . "Explain monads."))]))
</pre>
</div>
</div>
</div>
<div id="outline-container-org27f96da" class="outline-3">
<h3 id="org27f96da"><span class="section-number-3">7.2.</span> Parsing the Response</h3>
<div class="outline-text-3" id="text-7-2">
<p>
The API returns a JSON object with a <code>choices</code> array.  This helper
extracts the assistant's text content, signaling a clear error if the
response is malformed or contains an API error.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org0b7c523">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--parse-response</span> (json-string)
  <span class="org-doc">"Extract the assistant's message content from JSON-STRING.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' if the response indicates an API error
or has an unexpected structure."</span>
  (<span class="org-keyword">let*</span> ((data (<span class="org-keyword">condition-case</span> err
                   (json-read-from-string json-string)
                 (json-error
                  (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: failed to parse response JSON: %s"</span>
                              (error-message-string err)))))
         (err-msg (alist-get 'message (alist-get 'error data))))
    (<span class="org-keyword">when</span> err-msg
      (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: API error: %s"</span> err-msg))
    (<span class="org-keyword">condition-case</span> nil
        (alist-get 'content
                   (alist-get 'message
                              (aref (alist-get 'choices data) 0)))
      (<span class="org-warning">error</span>
       (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: unexpected response structure: %s"</span>
                   (truncate-string-to-width json-string 200))))))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-prompt">Can the response come as position greater than 0 in the choices?
</pre>
</div>

<div class="assistant" id="org66c8e4d">
<p>
In practice, almost never — and for your use case, you can safely
assume index 0.
</p>

<p>
More detail:
</p>

<ul class="org-ul">
<li>The OpenAI-compatible APIs define `choices` as an array to support:
<ul class="org-ul">
<li>`n &gt; 1` completions (legacy / sampling use cases)</li>
<li>parallel or speculative decoding (internal)</li>
</ul></li>
<li>When `n` is omitted (default = 1), the server returns exactly one element.</li>
<li>That element is always at index 0.</li>
<li>I'm not aware of any production API that returns the "primary"
response anywhere else.</li>
</ul>

<p>
So:
</p>

<ul class="org-ul">
<li>Yes, additional elements can exist in theory.</li>
<li>No, you should not expect the actual response to appear at a
non-zero index unless you explicitly requested multiple completions.</li>
</ul>

<p>
Your current parser is therefore correct and idiomatic.
</p>

<p>
If you wanted to be maximally defensive, the only reasonable extension
would be:
</p>
<ul class="org-ul">
<li>assert `(&gt; (length choices) 0)`</li>
<li>optionally concatenate contents when `n &gt; 1`</li>
</ul>

<p>
But for ob-prompt's design goals (single prompt → single response),
indexing `[0]` is exactly right.
</p>

</div>
</div>
<div id="outline-container-orgbb29c94" class="outline-4">
<h4 id="orgbb29c94"><span class="section-number-4">7.2.1.</span> Example</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
Parsing a realistic API response — you can see exactly what gets
extracted:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(ob-prompt--parse-response
 <span class="org-string">"{\"id\":\"chatcmpl-abc\",\"choices\":[{\"index\":0,\"message\":{\"role\":\"assistant\",\"content\":\"A monad is a design pattern.\"}}]}"</span>)
</pre>
</div>

<pre class="example" id="org4010479">
A monad is a design pattern.
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffb8d9d" class="outline-3">
<h3 id="orgffb8d9d"><span class="section-number-3">7.3.</span> ASCII-safe JSON Encoding</h3>
<div class="outline-text-3" id="text-7-3">
<p>
<code>url-http-create-request</code> rejects any request whose <code>string-bytes</code>
exceeds its <code>length</code> — i.e. any non-ASCII byte in the assembled
request string.  Since <code>json-encode</code> can produce literal non-ASCII
characters (em-dashes, curly quotes, etc. from preamble context), we
escape them to <code>\uNNNN</code> JSON sequences first.  Every conforming JSON
parser decodes these transparently.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org1957c8a">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--json-encode-ascii</span> (object)
  <span class="org-doc">"Encode OBJECT as JSON with all non-ASCII characters escaped to \\uNNNN.
This avoids `</span><span class="org-doc"><span class="org-constant">url-http-create-request</span></span><span class="org-doc">' failing with
\"Multibyte text in HTTP request\" (Emacs Bug#23750)."</span>
  (<span class="org-keyword">let</span> ((json (json-encode object)))
    (replace-regexp-in-string
     <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\x00-\x7f]"</span>
     (<span class="org-keyword">lambda</span> (char)
       (format <span class="org-string">"\\u%04x"</span> (string-to-char char)))
     json nil t)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org7925bb9" class="outline-3">
<h3 id="org7925bb9"><span class="section-number-3">7.4.</span> HTTP Transport</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org3bef14a">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--request</span> (endpoint api-key payload)
  <span class="org-doc">"Send PAYLOAD to ENDPOINT using API-KEY via built-in `</span><span class="org-doc"><span class="org-constant">url</span></span><span class="org-doc">'.
Returns the response body as a string.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' on HTTP or transport errors."</span>
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"POST"</span>)
         (url-request-extra-headers
          `((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)
            (<span class="org-string">"Authorization"</span> . ,(concat <span class="org-string">"Bearer "</span> api-key))))
         (url-request-data (ob-prompt--json-encode-ascii payload))
         (buffer (url-retrieve-synchronously endpoint t t 300)))
    (<span class="org-keyword">unless</span> buffer
      (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: request failed (no response buffer)"</span>))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">unwind-protect</span>
          (<span class="org-keyword">progn</span>
            (goto-char (point-min))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Check HTTP status
</span>            (<span class="org-keyword">unless</span> (looking-at <span class="org-string">"HTTP/.* 200"</span>)
              (re-search-forward <span class="org-string">"^HTTP/.* </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
              (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: HTTP error %s"</span>
                          (match-string 1)))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Skip headers
</span>            (re-search-forward <span class="org-string">"\r?\n\r?\n"</span> nil 'move)
            (decode-coding-string
             (buffer-substring-no-properties (point) (point-max))
             'utf-8))
        (kill-buffer buffer)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org054fe71" class="outline-2">
<h2 id="org054fe71"><span class="section-number-2">8.</span> CLI Backend</h2>
<div class="outline-text-2" id="text-8">
<p>
When <code>:command</code> is present on a block, ob-prompt switches to CLI
mode.  Instead of constructing an HTTP request, it pipes the prompt
text (after variable and noweb expansion) to the shell command via
<b>stdin</b> and captures <b>stdout</b> as the response.
</p>

<p>
This makes any CLI tool that reads a prompt from stdin an LLM backend
such as <code>claude code</code>, a custom wrapper script, or even <code>cat</code> for
testing:
</p>

<pre class="example" id="org96d005e">
#+begin_src prompt :command "cat"
Explain monads in simple terms.
#+end_src

#+RESULTS:
#+begin_assistant
&lt;context&gt;
Document content thus far...
&lt;/context&gt;

Explain monads in simple terms.
#+end_assistant
</pre>
</div>
<div id="outline-container-orgcc93e6a" class="outline-3">
<h3 id="orgcc93e6a"><span class="section-number-3">8.1.</span> Building CLI Input</h3>
<div class="outline-text-3" id="text-8-1">
<p>
The CLI transport receives plain text rather than a JSON payload.
When <code>:preamble yes</code> is set, the buffer context is wrapped in
<code>&lt;context&gt;</code> tags and prepended to the body — the same convention
used by the HTTP backend, so the LLM sees a consistent format
regardless of transport.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org4d1f1f6">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-cli-input</span> (body <span class="org-type">&amp;optional</span> preamble-text)
  <span class="org-doc">"Build the plain-text input string for CLI transport.
BODY is the user prompt.  PREAMBLE-TEXT is prepended wrapped in
context tags if non-nil."</span>
  (<span class="org-keyword">if</span> preamble-text
      (format <span class="org-string">"&lt;context&gt;\n%s\n&lt;/context&gt;\n\n%s"</span> preamble-text body)
    body))
</pre>
</div>
</div>
</div>
<div id="outline-container-org4d75a31" class="outline-3">
<h3 id="org4d75a31"><span class="section-number-3">8.2.</span> Shell Transport</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orge723a71">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--request-cli</span> (command input)
  <span class="org-doc">"Send INPUT to shell COMMAND via stdin, return stdout.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' on non-zero exit."</span>
  (<span class="org-keyword">with-temp-buffer</span>
    (<span class="org-keyword">let</span> ((exit-code (call-process-region
                      input nil shell-file-name nil t nil
                      shell-command-switch command)))
      (<span class="org-keyword">unless</span> (eq exit-code 0)
        (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: command failed (exit %s): %s"</span>
                    exit-code
                    (string-trim (buffer-string))))
      (string-trim-right (buffer-string)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2089a9f" class="outline-2">
<h2 id="org2089a9f"><span class="section-number-2">9.</span> The Core Execution Function</h2>
<div class="outline-text-2" id="text-9">
<p>
This is what Babel calls when you press <code>C-c C-c</code> on a <code>prompt</code>
block.  It is a thin orchestrator — all logic lives in the helpers
above.  The <code>:command</code> header argument selects the transport: when
present, the CLI backend is used; otherwise, the HTTP backend sends
to <code>:endpoint</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org6a557e1">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-execute:prompt</span> (body params)
  <span class="org-doc">"Execute a prompt BODY with PARAMS via Org Babel.
Sends the prompt to the configured LLM endpoint and returns
the response text."</span>
  (<span class="org-keyword">let*</span> ((model    (cdr (assq <span class="org-builtin">:model</span> params)))
         (endpoint (cdr (assq <span class="org-builtin">:endpoint</span> params)))
         (api-key  (cdr (assq <span class="org-builtin">:api-key</span> params)))
         (system   (cdr (assq <span class="org-builtin">:system</span> params)))
         (preamble (cdr (assq <span class="org-builtin">:preamble</span> params)))
         (debug    (cdr (assq <span class="org-builtin">:debug</span> params)))
         (command  (cdr (assq <span class="org-builtin">:command</span> params)))
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Gather buffer text above this src block when :preamble is set
</span>         (preamble-text
          (<span class="org-keyword">when</span> (equal preamble <span class="org-string">"yes"</span>)
            (<span class="org-keyword">let</span> ((src-block (org-element-at-point)))
              (buffer-substring-no-properties
               (point-min)
               (org-element-property <span class="org-builtin">:begin</span> src-block)))))
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Expand :var references in the body
</span>         (expanded-body (org-babel-expand-body:prompt body params)))
    (<span class="org-keyword">if</span> command
        <span class="org-comment-delimiter">;; </span><span class="org-comment">CLI mode &#8212; pipe plain text to command, return stdout directly
</span>        (<span class="org-keyword">let</span> ((input (ob-prompt--build-cli-input
                      expanded-body preamble-text)))
          (ob-prompt--request-cli command input))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">HTTP mode &#8212; build JSON payload, call API
</span>      (<span class="org-keyword">let*</span> ((messages (ob-prompt--build-messages
                        expanded-body system preamble-text))
             (payload (ob-prompt--build-payload model messages)))
        (<span class="org-keyword">if</span> (equal debug <span class="org-string">"yes"</span>)
            (ob-prompt--format-debug endpoint api-key payload)
          (ob-prompt--parse-response
           (ob-prompt--request endpoint api-key payload)))))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org5681d58" class="outline-2">
<h2 id="org5681d58"><span class="section-number-2">10.</span> Debug Mode</h2>
<div class="outline-text-2" id="text-10">
<p>
When <code>:debug yes</code> is set, instead of calling the API we return a
human-readable dump of what <i>would</i> be sent.  The API key is
redacted.  This only applies to the HTTP backend — the CLI backend
does not use debug mode since you can simply <code>echo</code> stdin in your
command to inspect it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org8da30c1">(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--format-debug</span> (endpoint api-key payload)
  <span class="org-doc">"Format a debug representation of the request.
Redacts API-KEY to show only the first and last 4 characters."</span>
  (<span class="org-keyword">let</span> ((redacted (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> api-key (&gt; (length api-key) 8))
                      (concat (substring api-key 0 4)
                              <span class="org-string">"..."</span>
                              (substring api-key -4))
                    <span class="org-string">"****"</span>)))
    (format <span class="org-string">"endpoint: %s\napi-key:  %s\npayload:\n%s"</span>
            endpoint redacted
            (json-encode payload))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc230d27" class="outline-2">
<h2 id="orgc230d27"><span class="section-number-2">11.</span> Session Support (stub)</h2>
<div class="outline-text-2" id="text-11">
<p>
Babel requires <code>org-babel-prep-session:LANG</code> to exist.  Full
multi-turn session support (maintaining conversation history across
blocks) is a future enhancement.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orgef958d1">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-prep-session:prompt</span> (_session _params)
  <span class="org-doc">"Prepare a prompt session.
Prompt sessions are not yet supported."</span>
  (<span class="org-warning">error</span> <span class="org-string">"ob-prompt: sessions are not yet implemented"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org99c8ade" class="outline-2">
<h2 id="org99c8ade"><span class="section-number-2">12.</span> Running Tests</h2>
<div class="outline-text-2" id="text-12">
<p>
The full ERT test suite lives in <code>ob-prompt-test.el</code> (not tangled
from this file).  Run it from the command line:
</p>

<div class="org-src-container">
<pre class="src src-shell">emacs -batch -L . -l ob-prompt-test.el -f ert-run-tests-batch-and-exit 2&gt;&amp;1
</pre>
</div>

<pre class="example" id="org773673d">
Running 21 tests (2026-02-20 21:01:52-0800, selector ‘t’)
   passed   1/21  ob-prompt-debug-no-calls-api (0.000096 sec)
   passed   2/21  ob-prompt-debug-redacts-key (0.000024 sec)
   passed   3/21  ob-prompt-debug-short-key (0.000015 sec)
   passed   4/21  ob-prompt-execute-debug-skips-http (0.000039 sec)
   passed   5/21  ob-prompt-execute-round-trip (0.000045 sec)
   passed   6/21  ob-prompt-expand-body-no-vars (0.000012 sec)
   passed   7/21  ob-prompt-expand-body-substitutes-vars (0.000016 sec)
   passed   8/21  ob-prompt-json-encode-ascii-escapes-non-ascii (0.000029 sec)
   passed   9/21  ob-prompt-messages-body-only (0.000011 sec)
   passed  10/21  ob-prompt-messages-nil-system-ignored (0.000011 sec)
   passed  11/21  ob-prompt-messages-system-and-preamble (0.000013 sec)
   passed  12/21  ob-prompt-messages-with-preamble (0.000016 sec)
   passed  13/21  ob-prompt-messages-with-system (0.000015 sec)
   passed  14/21  ob-prompt-parse-api-error (0.000026 sec)
   passed  15/21  ob-prompt-parse-malformed-json (0.000029 sec)
   passed  16/21  ob-prompt-parse-unexpected-structure (0.000020 sec)
   passed  17/21  ob-prompt-parse-valid-response (0.000016 sec)
   passed  18/21  ob-prompt-payload-basic (0.000012 sec)
   passed  19/21  ob-prompt-preamble-no-disables-context (0.000031 sec)
   passed  20/21  ob-prompt-request-decodes-utf8-response (0.000041 sec)
   passed  21/21  ob-prompt-request-sends-auth-header (0.000037 sec)

Ran 21 tests, 21 results as expected, 0 unexpected (2026-02-20 21:01:52-0800, 0.000822 sec)

</pre>

<p>
Or interactively from within Emacs:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(load-file <span class="org-string">"ob-prompt-test.el"</span>)
(ert-run-tests-batch <span class="org-string">"^ob-prompt-"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdb667da" class="outline-2">
<h2 id="orgdb667da"><span class="section-number-2">13.</span> Example Usage</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-orgdff7531" class="outline-3">
<h3 id="orgdff7531"><span class="section-number-3">13.1.</span> Basic prompt</h3>
<div class="outline-text-3" id="text-13-1">
<pre class="example" id="orga270ec6">
#+begin_src prompt :results raw
How do LLMs improve literate programming?
#+end_src
</pre>

<div class="org-src-container">
<pre class="src src-prompt">How do LLMs improve literate programming?
</pre>
</div>

<div class="assistant" id="orga5f3c67">
<p>
LLMs improve literate programming mainly by tightening the feedback loop
between explanation and implementation.
</p>

<p>
Concretely:
</p>

<ul class="org-ul">
<li>They act as an always-available reviewer, questioning design choices
and spotting inconsistencies between prose and code.</li>
<li>They help draft, refine, and align narrative explanations with the
actual behavior of the code.</li>
<li>They make examples "live": you can regenerate explanations or
variations directly from the source document.</li>
<li>They reduce friction in exploratory writing, letting you iterate on
structure and wording without breaking flow.</li>
</ul>

<p>
In short, LLMs turn literate programming from a static exposition into
an interactive dialogue, while keeping the document itself as the
single source of truth.
</p>

</div>
</div>
</div>
<div id="outline-container-orgd1d4e2b" class="outline-3">
<h3 id="orgd1d4e2b"><span class="section-number-3">13.2.</span> With a system prompt</h3>
<div class="outline-text-3" id="text-13-2">
<pre class="example" id="orgdb4256d">
#+begin_src prompt :system "You are a concise technical writer. Who speaks like a pirate..." :results raw
How does emacs org mode support literate programming?
#+end_src
</pre>

<div class="org-src-container">
<pre class="src src-prompt">How does emacs org mode support literate programming?
</pre>
</div>

<div class="assistant" id="org6ec7897">
<p>
Arrr, listen close, matey:
</p>

<p>
Emacs Org mode be a fine vessel for literate programmin' because it lets ye weave code and prose into one sturdy logbook.
</p>

<p>
In plain seaspeak:
</p>

<ul class="org-ul">
<li>Ye write explanations, design notes, and code side by side in one Org file.</li>
<li>Code lives in Babel src blocks, which can be tangled into real source files or executed right there on deck.</li>
<li>Results of execution come back into the document, keepin' the tale honest and reproducible.</li>
<li>Multiple languages sail together — Lisp, Python, shell, and more — all in one chart.</li>
<li>Export turns the same file into HTML, PDF, or plain text, without losin' the narrative.</li>
</ul>

<p>
So Org mode ain't just holdin' code — it tells the story of <b>why</b> the code exists, and proves it works. A proper captain's log, savvy? ☠️
</p>

</div>
</div>
</div>
<div id="outline-container-orgc628981" class="outline-3">
<h3 id="orgc628981"><span class="section-number-3">13.3.</span> With variables from other blocks</h3>
<div class="outline-text-3" id="text-13-3">
<p>
Org Mode's <a href="https://orgmode.org/manual/Noweb-Reference-Syntax.html">noweb</a> feature lets you reference other code blocks from
within a prompt block. This makes it easy to do things like ask the
LLM to review or explain previously defined code.
</p>

<p>
To use it, enable <code>:noweb yes</code> in the prompt block header and insert
references to named blocks using <code>&lt;&lt;name&gt;&gt;</code>. When the block is
executed, those references are expanded in place, and the resolved
content is sent as part of the prompt.
</p>

<pre class="example" id="orgd525bb0">
#+name: my-code
#+begin_src python :exports none :python python3
def fibonacci(n):
    a, b = 0, 1
    for _ in range(n):
        a, b = b, a + b
    return a
#+end_src

#+begin_src prompt :var code=my-code :results raw :preamble no :noweb yes :wrap example
Review this code and suggest improvements:

&lt;&lt;my-code&gt;&gt;
#+end_src
</pre>

<div class="org-src-container">
<pre class="src src-prompt">Review this code and suggest improvements: (output your results in normal text format). Make sure to reference specific parts of the code / lines

def fibonacci(n):
    a, b = 0, 1
    for _ in range(n):
        a, b = b, a + b
    return a
</pre>
</div>

<div class="assistant" id="orga93fa3d">
<pre class="example" id="org8cea29b">
Here is a brief review with specific suggestions:

1. **Function signature (line 1)**
   - The function does not specify expected input types or behavior for edge cases.
   - Improvement: Add a docstring describing what `n` represents (e.g., zero-based index), expected type (`int`), and return value.
   - Consider type hints: `def fibonacci(n: int) -&gt; int:`.

2. **Input validation (line 1–2)**
   - The function assumes `n` is a non-negative integer.
   - Improvement: Explicitly check for invalid inputs (e.g., negative values or non-integers) and raise a `ValueError` or `TypeError`.

3. **Initialization clarity (line 2)**
   - `a, b = 0, 1` is correct but implicit.
   - Improvement: Add a short comment explaining that `a` and `b` track consecutive Fibonacci numbers for readability, especially for less experienced readers.

4. **Loop construct (line 3)**
   - `for _ in range(n):` is idiomatic and efficient.
   - Improvement: None required, but you could rename `_` to something like `i` if step-wise debugging or clarity is desired.

5. **Return value semantics (line 5)**
   - The function returns `a`, which corresponds to `F(n)` with `F(0) = 0`.
   - Improvement: Explicitly document this convention in the docstring, as some definitions use different starting indices.

6. **Testing and examples (missing)**
   - There are no usage examples.
   - Improvement: Include example calls in a docstring or separate test cases to clarify expected behavior (e.g., `fibonacci(0) == 0`, `fibonacci(1) == 1`).
</pre>

</div>
</div>
</div>
<div id="outline-container-orgd22ad27" class="outline-3">
<h3 id="orgd22ad27"><span class="section-number-3">13.4.</span> Using :preamble for document context</h3>
<div class="outline-text-3" id="text-13-4">
<p>
When <code>:preamble yes</code> is set, the entire buffer content above the
block is sent as context, wrapped in <code>&lt;context&gt;</code> tags.  This is
powerful for literate documents where earlier sections inform later
prompts:
</p>

<pre class="example" id="org376ac9f">
#+begin_src prompt :preamble yes :results drawer
Given the code and discussion above, what edge cases are missing?
#+end_src
</pre>
</div>
</div>
<div id="outline-container-org742aa22" class="outline-3">
<h3 id="org742aa22"><span class="section-number-3">13.5.</span> Using :command for CLI tools</h3>
<div class="outline-text-3" id="text-13-5">
<p>
Any CLI tool that reads from stdin can serve as an LLM backend.  This
is useful for tools like <code>claude code</code>, or custom wrapper scripts:
</p>

<pre class="example" id="org105223f">
#+begin_src prompt :command "llm -m claude-sonnet-4-6"
Explain monads in simple terms.
#+end_src
</pre>

<p>
The <code>:preamble</code> mechanism works identically — when set to <code>yes</code>,
buffer content above the block is prepended in <code>&lt;context&gt;</code> tags.
The <code>:system</code> header argument is not used in CLI mode; pass system
prompt flags directly in the command string if your tool supports
them.
</p>
</div>
</div>
</div>
<div id="outline-container-org1827a6b" class="outline-2">
<h2 id="org1827a6b"><span class="section-number-2">14.</span> File Assembly</h2>
<div class="outline-text-2" id="text-14">
<p>
Every Emacs Lisp package needs a standard file header (library
commentary, dependency declarations) and a closing <code>provide</code> form.
Rather than clutter the top of the document with boilerplate, we
define them here and let noweb compose the final <code>ob-prompt.el</code> in the
correct order.
</p>
</div>
<div id="outline-container-orgad17b79" class="outline-3">
<h3 id="orgad17b79"><span class="section-number-3">14.1.</span> File header</h3>
<div class="outline-text-3" id="text-14-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="orga9abd1f"><span class="org-comment-delimiter">;;; </span><span class="org-comment">ob-prompt.el --- Org Babel functions for LLM prompts -*- lexical-binding: t; -*-
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Copyright (C) 2026 Pablo Munoz
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Author: Pablo Munoz <a href="mailto:contact%40slashpablo.com">&lt;contact@slashpablo.com&gt;</a>
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Maintainer: Pablo Munoz <a href="mailto:contact%40slashpablo.com">&lt;contact@slashpablo.com&gt;</a>
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">URL: https://github.com/slashpablo/ob-prompt
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Version: 0.1.0
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Package-Requires: ((emacs "28.1") (org "9.7"))
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Keywords: org, babel, ai, llm
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">This file is part of ob-prompt.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">ob-prompt is free software: you can redistribute it and/or modify
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">it under the terms of the GNU General Public License as published by
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">the Free Software Foundation, either version 3 of the License, or
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">(at your option) any later version.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">ob-prompt is distributed in the hope that it will be useful,
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">GNU General Public License for more details.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">You should have received a copy of the GNU General Public License
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">along with ob-prompt.  If not, see <a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a>.
</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Commentary:
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Org Babel support for executing LLM prompts as src blocks.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Usage:
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">#+begin_src prompt :model claude-sonnet-4-5-20250929 :results raw
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">Explain monads in simple terms.
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">#+end_src
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Press C-c C-c on the block to send the prompt to an LLM
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">and insert the response as a #+RESULTS: block.
</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Code:
</span>
(<span class="org-keyword">require</span> '<span class="org-constant">ob</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org-element</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org-macs</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">json</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">url</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc927e9b" class="outline-3">
<h3 id="orgc927e9b"><span class="section-number-3">14.2.</span> Provide</h3>
<div class="outline-text-3" id="text-14-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org0acccad">(<span class="org-keyword">provide</span> '<span class="org-constant">ob-prompt</span>)

<span class="org-comment-delimiter">;;; </span><span class="org-comment">ob-prompt.el ends here</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfe54d00" class="outline-3">
<h3 id="orgfe54d00"><span class="section-number-3">14.3.</span> Tangled output</h3>
<div class="outline-text-3" id="text-14-3">
<p>
This single block tangles into <code>ob-prompt.el</code>.  The noweb references
pull in every named block in the order an Emacs Lisp package expects:
header, declarations, implementation, provide.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span class="org-comment-delimiter">;;; </span><span class="org-comment">ob-prompt.el --- Org Babel functions for LLM prompts -*- lexical-binding: t; -*-
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Copyright (C) 2026 Pablo Munoz
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Author: Pablo Munoz <a href="mailto:contact%40slashpablo.com">&lt;contact@slashpablo.com&gt;</a>
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Maintainer: Pablo Munoz <a href="mailto:contact%40slashpablo.com">&lt;contact@slashpablo.com&gt;</a>
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">URL: https://github.com/slashpablo/ob-prompt
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Version: 0.1.0
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Package-Requires: ((emacs "28.1") (org "9.7"))
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Keywords: org, babel, ai, llm
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">This file is part of ob-prompt.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">ob-prompt is free software: you can redistribute it and/or modify
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">it under the terms of the GNU General Public License as published by
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">the Free Software Foundation, either version 3 of the License, or
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">(at your option) any later version.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">ob-prompt is distributed in the hope that it will be useful,
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">but WITHOUT ANY WARRANTY; without even the implied warranty of
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">GNU General Public License for more details.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">You should have received a copy of the GNU General Public License
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">along with ob-prompt.  If not, see <a href="https://www.gnu.org/licenses/">&lt;https://www.gnu.org/licenses/&gt;</a>.
</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Commentary:
</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Org Babel support for executing LLM prompts as src blocks.
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Usage:
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">#+begin_src prompt :model claude-sonnet-4-5-20250929 :results raw
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">Explain monads in simple terms.
</span><span class="org-comment-delimiter">;;   </span><span class="org-comment">#+end_src
</span><span class="org-comment-delimiter">;;</span><span class="org-comment">
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">Press C-c C-c on the block to send the prompt to an LLM
</span><span class="org-comment-delimiter">;; </span><span class="org-comment">and insert the response as a #+RESULTS: block.
</span>
<span class="org-comment-delimiter">;;; </span><span class="org-comment">Code:
</span>
(<span class="org-keyword">require</span> '<span class="org-constant">ob</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org-element</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">org-macs</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">json</span>)
(<span class="org-keyword">require</span> '<span class="org-constant">url</span>)

(<span class="org-keyword">defconst</span> <span class="org-variable-name">org-babel-header-args:prompt</span>
  '((model    . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">LLM model identifier
</span>    (system   . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">system prompt string
</span>    (endpoint . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">API endpoint URL
</span>    (api-key  . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">API key (string or evaluated form)
</span>    (preamble . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">include buffer content above block as context
</span>    (command  . <span class="org-builtin">:any</span>)   <span class="org-comment-delimiter">;; </span><span class="org-comment">shell command for CLI backend (reads stdin)
</span>    (debug    . <span class="org-builtin">:any</span>))  <span class="org-comment-delimiter">;; </span><span class="org-comment">return raw request/response instead of content
</span>  <span class="org-doc">"Prompt-specific header arguments for ob-prompt."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">org-babel-default-header-args:prompt</span>
  '((<span class="org-builtin">:results</span> . <span class="org-string">"raw"</span>)
    (<span class="org-builtin">:exports</span> . <span class="org-string">"both"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Ensures both prompt and result are exported
</span>    (<span class="org-builtin">:eval</span> . <span class="org-string">"no-export"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Do not re-evaluate prompt blocks on export
</span>    (<span class="org-builtin">:wrap</span> . <span class="org-string">"assistant"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">Provide concrete boundries to responses
</span>    (<span class="org-builtin">:noweb</span> . <span class="org-string">"yes"</span>)) <span class="org-comment-delimiter">;; </span><span class="org-comment">Enable &lt;&lt;block-name&gt;&gt; inclusion by default
</span>  <span class="org-doc">"Default header arguments for prompt src blocks."</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-expand-body:prompt</span> (body params)
  <span class="org-doc">"Expand BODY for a prompt block by substituting :var references.
Each :var binding replaces $name in BODY with the variable's value."</span>
  (<span class="org-keyword">let</span> ((expanded body))
    (<span class="org-keyword">dolist</span> (pair (org-babel--get-vars params) expanded)
      (<span class="org-keyword">setq</span> expanded
            (replace-regexp-in-string
             (regexp-quote (format <span class="org-string">"$%s"</span> (car pair)))
             (<span class="org-keyword">save-match-data</span> (format <span class="org-string">"%s"</span> (cdr pair)))
             expanded
             t t)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-messages</span> (body <span class="org-type">&amp;optional</span> system preamble-text)
  <span class="org-doc">"Build the messages vector for the API request.
BODY is the user's prompt text.
SYSTEM, when non-nil, becomes a system message.
PREAMBLE-TEXT, when non-nil, is wrapped in &lt;context&gt; tags
and prepended to the user message."</span>
  (<span class="org-keyword">let</span> ((user-content (<span class="org-keyword">if</span> preamble-text
                          (format <span class="org-string">"&lt;context&gt;\n%s\n&lt;/context&gt;\n\n%s"</span>
                                  preamble-text body)
                        body))
        (messages '()))
    (<span class="org-keyword">when</span> system
      (<span class="org-keyword">push</span> `((role . <span class="org-string">"system"</span>) (content . ,system)) messages))
    (<span class="org-keyword">push</span> `((role . <span class="org-string">"user"</span>) (content . ,user-content)) messages)
    (vconcat (nreverse messages))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-payload</span> (model messages)
  <span class="org-doc">"Build the JSON-ready alist for the API request.
MODEL is the model identifier string.
MESSAGES is the vector returned by `</span><span class="org-doc"><span class="org-constant">ob-prompt--build-messages</span></span><span class="org-doc">'."</span>
  `((<span class="org-string">"model"</span> . ,model)
    (<span class="org-string">"max_completion_tokens"</span> . 16384)
    (<span class="org-string">"messages"</span> . ,messages)))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--parse-response</span> (json-string)
  <span class="org-doc">"Extract the assistant's message content from JSON-STRING.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' if the response indicates an API error
or has an unexpected structure."</span>
  (<span class="org-keyword">let*</span> ((data (<span class="org-keyword">condition-case</span> err
                   (json-read-from-string json-string)
                 (json-error
                  (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: failed to parse response JSON: %s"</span>
                              (error-message-string err)))))
         (err-msg (alist-get 'message (alist-get 'error data))))
    (<span class="org-keyword">when</span> err-msg
      (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: API error: %s"</span> err-msg))
    (<span class="org-keyword">condition-case</span> nil
        (alist-get 'content
                   (alist-get 'message
                              (aref (alist-get 'choices data) 0)))
      (<span class="org-warning">error</span>
       (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: unexpected response structure: %s"</span>
                   (truncate-string-to-width json-string 200))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--json-encode-ascii</span> (object)
  <span class="org-doc">"Encode OBJECT as JSON with all non-ASCII characters escaped to \\uNNNN.
This avoids `</span><span class="org-doc"><span class="org-constant">url-http-create-request</span></span><span class="org-doc">' failing with
\"Multibyte text in HTTP request\" (Emacs Bug#23750)."</span>
  (<span class="org-keyword">let</span> ((json (json-encode object)))
    (replace-regexp-in-string
     <span class="org-string">"[</span><span class="org-string"><span class="org-negation-char">^</span></span><span class="org-string">\x00-\x7f]"</span>
     (<span class="org-keyword">lambda</span> (char)
       (format <span class="org-string">"\\u%04x"</span> (string-to-char char)))
     json nil t)))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--request</span> (endpoint api-key payload)
  <span class="org-doc">"Send PAYLOAD to ENDPOINT using API-KEY via built-in `</span><span class="org-doc"><span class="org-constant">url</span></span><span class="org-doc">'.
Returns the response body as a string.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' on HTTP or transport errors."</span>
  (<span class="org-keyword">let*</span> ((url-request-method <span class="org-string">"POST"</span>)
         (url-request-extra-headers
          `((<span class="org-string">"Content-Type"</span> . <span class="org-string">"application/json"</span>)
            (<span class="org-string">"Authorization"</span> . ,(concat <span class="org-string">"Bearer "</span> api-key))))
         (url-request-data (ob-prompt--json-encode-ascii payload))
         (buffer (url-retrieve-synchronously endpoint t t 300)))
    (<span class="org-keyword">unless</span> buffer
      (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: request failed (no response buffer)"</span>))
    (<span class="org-keyword">with-current-buffer</span> buffer
      (<span class="org-keyword">unwind-protect</span>
          (<span class="org-keyword">progn</span>
            (goto-char (point-min))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Check HTTP status
</span>            (<span class="org-keyword">unless</span> (looking-at <span class="org-string">"HTTP/.* 200"</span>)
              (re-search-forward <span class="org-string">"^HTTP/.* </span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">[0-9]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
              (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: HTTP error %s"</span>
                          (match-string 1)))
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Skip headers
</span>            (re-search-forward <span class="org-string">"\r?\n\r?\n"</span> nil 'move)
            (decode-coding-string
             (buffer-substring-no-properties (point) (point-max))
             'utf-8))
        (kill-buffer buffer)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--build-cli-input</span> (body <span class="org-type">&amp;optional</span> preamble-text)
  <span class="org-doc">"Build the plain-text input string for CLI transport.
BODY is the user prompt.  PREAMBLE-TEXT is prepended wrapped in
context tags if non-nil."</span>
  (<span class="org-keyword">if</span> preamble-text
      (format <span class="org-string">"&lt;context&gt;\n%s\n&lt;/context&gt;\n\n%s"</span> preamble-text body)
    body))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--request-cli</span> (command input)
  <span class="org-doc">"Send INPUT to shell COMMAND via stdin, return stdout.
Signals `</span><span class="org-doc"><span class="org-constant">user-error</span></span><span class="org-doc">' on non-zero exit."</span>
  (<span class="org-keyword">with-temp-buffer</span>
    (<span class="org-keyword">let</span> ((exit-code (call-process-region
                      input nil shell-file-name nil t nil
                      shell-command-switch command)))
      (<span class="org-keyword">unless</span> (eq exit-code 0)
        (<span class="org-warning">user-error</span> <span class="org-string">"ob-prompt: command failed (exit %s): %s"</span>
                    exit-code
                    (string-trim (buffer-string))))
      (string-trim-right (buffer-string)))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-execute:prompt</span> (body params)
  <span class="org-doc">"Execute a prompt BODY with PARAMS via Org Babel.
Sends the prompt to the configured LLM endpoint and returns
the response text."</span>
  (<span class="org-keyword">let*</span> ((model    (cdr (assq <span class="org-builtin">:model</span> params)))
         (endpoint (cdr (assq <span class="org-builtin">:endpoint</span> params)))
         (api-key  (cdr (assq <span class="org-builtin">:api-key</span> params)))
         (system   (cdr (assq <span class="org-builtin">:system</span> params)))
         (preamble (cdr (assq <span class="org-builtin">:preamble</span> params)))
         (debug    (cdr (assq <span class="org-builtin">:debug</span> params)))
         (command  (cdr (assq <span class="org-builtin">:command</span> params)))
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Gather buffer text above this src block when :preamble is set
</span>         (preamble-text
          (<span class="org-keyword">when</span> (equal preamble <span class="org-string">"yes"</span>)
            (<span class="org-keyword">let</span> ((src-block (org-element-at-point)))
              (buffer-substring-no-properties
               (point-min)
               (org-element-property <span class="org-builtin">:begin</span> src-block)))))
         <span class="org-comment-delimiter">;; </span><span class="org-comment">Expand :var references in the body
</span>         (expanded-body (org-babel-expand-body:prompt body params)))
    (<span class="org-keyword">if</span> command
        <span class="org-comment-delimiter">;; </span><span class="org-comment">CLI mode &#8212; pipe plain text to command, return stdout directly
</span>        (<span class="org-keyword">let</span> ((input (ob-prompt--build-cli-input
                      expanded-body preamble-text)))
          (ob-prompt--request-cli command input))
      <span class="org-comment-delimiter">;; </span><span class="org-comment">HTTP mode &#8212; build JSON payload, call API
</span>      (<span class="org-keyword">let*</span> ((messages (ob-prompt--build-messages
                        expanded-body system preamble-text))
             (payload (ob-prompt--build-payload model messages)))
        (<span class="org-keyword">if</span> (equal debug <span class="org-string">"yes"</span>)
            (ob-prompt--format-debug endpoint api-key payload)
          (ob-prompt--parse-response
           (ob-prompt--request endpoint api-key payload)))))))

(<span class="org-keyword">defun</span> <span class="org-function-name">ob-prompt--format-debug</span> (endpoint api-key payload)
  <span class="org-doc">"Format a debug representation of the request.
Redacts API-KEY to show only the first and last 4 characters."</span>
  (<span class="org-keyword">let</span> ((redacted (<span class="org-keyword">if</span> (<span class="org-keyword">and</span> api-key (&gt; (length api-key) 8))
                      (concat (substring api-key 0 4)
                              <span class="org-string">"..."</span>
                              (substring api-key -4))
                    <span class="org-string">"****"</span>)))
    (format <span class="org-string">"endpoint: %s\napi-key:  %s\npayload:\n%s"</span>
            endpoint redacted
            (json-encode payload))))

(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-prep-session:prompt</span> (_session _params)
  <span class="org-doc">"Prepare a prompt session.
Prompt sessions are not yet supported."</span>
  (<span class="org-warning">error</span> <span class="org-string">"ob-prompt: sessions are not yet implemented"</span>))

(<span class="org-keyword">provide</span> '<span class="org-constant">ob-prompt</span>)

<span class="org-comment-delimiter">;;; </span><span class="org-comment">ob-prompt.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: <a href="https://slashpablo.com"><span class="slash"></span>pablo</a></p>
<p class="date">Created: 2026-02-20 Fri 21:01</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
